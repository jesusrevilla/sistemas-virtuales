name: SSH into EC2

on:
  workflow_dispatch:

jobs:
  ssh-ec2:
    runs-on: ubuntu-latest


    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}      # e.g., ec2-user@54.12.34.56
      EC2_PEM_BASE64: ${{ secrets.EC2_PEM_BASE64 }}
      EC2_KNOWN_HOST: ${{ secrets.EC2_KNOWN_HOST }}
    

    steps:
    
    - name: Inspect and sanitize EC2_HOST
      run: |
        echo "Raw EC2_HOST (debug, length only): ${#EC2_HOST} chars"
        # Show safely-escaped representation (so we can see hidden chars)
        printf 'EC2_HOST (escaped) = [%q]\n' "$EC2_HOST"
    
        # Remove Windows CR, trim whitespace
        EC2_HOST_CLEAN="$(printf '%s' "$EC2_HOST" | tr -d '\r' | xargs)"
        echo "After cleanup (escaped) = [$(printf '%q' "$EC2_HOST_CLEAN")]"
        echo "EC2_HOST_CLEAN=$EC2_HOST_CLEAN" >> $GITHUB_ENV    

    - name: Decode PEM file
      run: |
        echo "$EC2_PEM_BASE64" | base64 --decode > private-key.pem
        chmod 600 private-key.pem

    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        echo "$EC2_KNOWN_HOST" >> ~/.ssh/known_hosts

    - name: Execute SSH command on EC2
      run: |
        ssh  -o StrictHostKeyChecking=no -i private-key.pem "$EC2_HOST_CLEAN" "echo 'Connected successfully!' && uname -a"
